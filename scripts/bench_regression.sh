#!/bin/bash

V1="$1"
V2="$2"
RESULT_DIR="regression"
REPORT="$RESULT_DIR/report.md"
INPUTS_DIR="./bench_inputs"
WARMUP_COUNT=5

rm -rf "$RESULT_DIR"
mkdir -p "$RESULT_DIR"

echo "# Regression Benchmark" >> "$REPORT"
echo "This file is generated by hyperfine." >> "$REPORT"

for FILE in "$INPUTS_DIR"/*
do
  NAME=$(basename "$FILE")
  # Get file stem. For example, this turns "bench.sh" into "bench"
  FILE_STEM="${NAME%%.*}"
  echo
  echo "Benching for \"$FILE_STEM\""
  echo
  hyperfine --warmup "$WARMUP_COUNT" \
    "$V1 '$FILE' --stdout" \
    "$V2 '$FILE' --stdout" \
    --shell=none \
    --export-markdown "$RESULT_DIR/$FILE_STEM.md"
  { echo; echo "## $FILE_STEM"; echo; } >> "$REPORT"
  cat "$RESULT_DIR/$FILE_STEM.md" >> "$REPORT"
  rm "$RESULT_DIR/$FILE_STEM.md"
done
